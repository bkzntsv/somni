# iOS and WatchOS build and TestFlight upload
# Requires: Xcode project in repo, App Store Connect API key, signing certificates
name: iOS & WatchOS Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-ios-watchos:
    name: Build and Upload to TestFlight
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run SwiftLint
        run: |
          brew install swiftlint 2>/dev/null || true
          if command -v swiftlint >/dev/null 2>&1; then
            swiftlint lint --path iosApp --path watchApp --strict 2>/dev/null || true
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Build KMP shared framework
        run: ./gradlew :shared:compileKotlinIosSimulatorArm64 --no-daemon

      - name: Select Xcode (use runner default)
        run: xcode-select -p

      - name: Install Apple certificate and provisioning profile and provisioning profile
        if: ${{ env.USE_SIGNING != 'false' }}
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_NAME: ${{ secrets.KEYCHAIN_NAME }}
        run: |
          if [ -z "$BUILD_CERTIFICATE_BASE64" ]; then
            echo "Skipping signing: no BUILD_CERTIFICATE_BASE64 secret."
            exit 0
          fi
          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME" || true
          security set-keychain-settings -lu -t 3600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o certificate.p12
          security import certificate.p12 -k "$KEYCHAIN_NAME" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          if [ -n "$BUILD_PROVISION_PROFILE_BASE64" ]; then
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o profile.mobileprovision
            mv profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          fi

      - name: Build iOS app (placeholder)
        run: |
          if [ -d "iosApp/Somni/Somni.xcodeproj" ] || [ -d "iosApp/Somni.xcodeproj" ]; then
            xcodebuild -scheme Somni -destination 'generic/platform=iOS' -configuration Release build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO || true
          else
            echo "No Xcode project found. Add iosApp/*.xcodeproj and configure scheme for full build."
          fi

      - name: Upload to TestFlight (placeholder)
        if: success() && github.ref == 'refs/heads/main'
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then
            echo "Skipping TestFlight upload: set APP_STORE_CONNECT_* secrets to enable."
          else
            echo "Configure xcrun altool or fastlane to upload IPA to TestFlight."
          fi
